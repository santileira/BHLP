USE [GD2C2015]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



-- =============================================================================================
-- Descripción:	Creación de Esquema
-- =============================================================================================

--CREATE SCHEMA [ABSTRACCIONX4] AUTHORIZATION [gd]
--GO

-- =============================================================================================
-- Descripción:	Creación de Tablas
-- =============================================================================================


--Rol: Si el estado es 0, se encuentra inactivo, si es 1 activo.
--Esta tabla contiene código, nombre y estado del rol (activo/inactivo)


CREATE TABLE [ABSTRACCIONX4].[ROLES](
	[ROL_COD] [int] IDENTITY NOT NULL,
	[ROL_ESTADO] [int] NULL,
	[ROL_NOMBRE] [varchar](255) COLLATE Modern_Spanish_CI_AS NOT NULL, /*Falta checkear si es adm o cliente*/
 CONSTRAINT [PK_ROLES] PRIMARY KEY CLUSTERED 
(
	[ROL_COD] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


--Tabla Funcionalidad: Contiene los códigos, nombres de cada funcionalidad. 
CREATE TABLE [ABSTRACCIONX4].[FUNCIONALIDADES](
	[FUNC_COD] [numeric] (18,0) NOT NULL,
	[FUNC_DESC] [varchar] (255) COLLATE Modern_Spanish_CI_AS NULL,
CONSTRAINT [PK_FUNCIONALIDADES] PRIMARY KEY CLUSTERED 
(
	[FUNC_COD] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

--Tabla Funciones por rol: Contiene las funcionalidades habilitadas para cada rol del sistema.
CREATE TABLE [ABSTRACCIONX4].[FUNCIONES_ROLES](
	[ROL_COD] [int] NOT NULL,
	[FUNC_COD] [numeric] (18,0) NOT NULL,
 CONSTRAINT [PK_FUNCIONES_ROLES] PRIMARY KEY CLUSTERED 
(
	[ROL_COD] ASC,
	[FUNC_COD] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


ALTER TABLE [ABSTRACCIONX4].[FUNCIONES_ROLES]  WITH CHECK ADD  CONSTRAINT [FK_FUNCIONES_ROLES_ROLES] FOREIGN KEY([ROL_COD])
REFERENCES [ABSTRACCIONX4].[ROLES] ([ROL_COD])

GO

ALTER TABLE [ABSTRACCIONX4].[FUNCIONES_ROLES]  WITH CHECK ADD  CONSTRAINT [FK_FUNCIONES_ROLES_FUNCIONALIDADES] FOREIGN KEY([FUNC_COD])
REFERENCES [ABSTRACCIONX4].[FUNCIONALIDADES] ([FUNC_COD])

GO


-- Tabla Usuarios: 

CREATE TABLE [ABSTRACCIONX4].[USUARIOS](
	[USERNAME] [varchar] (100) NOT NULL,
	[PASSWORD] [varchar] (100) NOT NULL,
	[ROL_COD] [int] NULL,
 CONSTRAINT [PK_USUARIOS] PRIMARY KEY CLUSTERED 
(
	[USERNAME] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [ABSTRACCIONX4].[USUARIOS]  WITH CHECK ADD  CONSTRAINT [FK_USUARIOS_ROLES] FOREIGN KEY([ROL_COD])
REFERENCES [ABSTRACCIONX4].[ROLES] ([ROL_COD])

GO

-- Tabla Ciudades:

CREATE TABLE [ABSTRACCIONX4].[CIUDADES](
	[CIU_COD] [int] IDENTITY NOT NULL,
	[CIU_DESC] [varchar] (255) NOT NULL,
 CONSTRAINT [PK_CIUDADES] PRIMARY KEY CLUSTERED 
(
	[CIU_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

-- Tabla Ruta Aérea:

CREATE TABLE [ABSTRACCIONX4].[RUTAS_AEREAS](
	[RUTA_COD] [int] NOT NULL,
	[RUTA_SERV] [varchar] (100) NOT NULL,
	[CIU_COD_O] [int] NOT NULL,
	[CIU_COD_D] [int] NOT NULL,
	[RUTA_PRECIO_BASE_KG] [varchar] (100) NOT NULL,
	[RUTA_PRECIO_BASE_PASAJE] [varchar] (100) NOT NULL,
 CONSTRAINT [PK_RUTAS_AEREAS] PRIMARY KEY CLUSTERED 
(
	[RUTA_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [ABSTRACCIONX4].[RUTAS_AEREAS]  WITH CHECK ADD  CONSTRAINT [FK_RUTAS_AEREAS_CIUDADES_O] FOREIGN KEY([CIU_COD_O])
REFERENCES [ABSTRACCIONX4].[CIUDADES] ([CIU_COD])

GO

ALTER TABLE [ABSTRACCIONX4].[RUTAS_AEREAS]  WITH CHECK ADD  CONSTRAINT [FK_RUTAS_AEREAS_CIUDADES_D] FOREIGN KEY([CIU_COD_D])
REFERENCES [ABSTRACCIONX4].[CIUDADES] ([CIU_COD])

GO

-- Tabla de Aeronaves

CREATE TABLE [ABSTRACCIONX4].[AERONAVES](
	[AERO_FECHA_ALTA] [date] NULL,
	[AERO_MOD] [varchar] (255) NOT NULL,
	[AERO_MATRI] [varchar] (8) NOT NULL,
	[AERO_FAB] [varchar] (255) NOT NULL,	
	[AERO_SERV] [varchar] (100) NOT NULL,	
	[AERO_BAJA_FS] [int] NULL,
	[AERO_BAJA_VU] [int] NULL,
	[AERO_FECHA_FS] [int] NULL,
	[AERO_FECHA_RS] [int] NULL,
	[AERO_FECHA_BAJA] [int] NULL,
	[AERO_CANT_BUTACAS] [int] NOT NULL,
	[AERO_CANT_KGS] [int] NULL,
 CONSTRAINT [PK_AERONAVES] PRIMARY KEY CLUSTERED 
(
	[AERO_MATRI] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


-- Tabla De Viajes

CREATE TABLE [ABSTRACCIONX4].[VIAJES](
	[VIAJE_COD] [int] IDENTITY NOT NULL,
	[VIAJE_FECHA_SALIDA] [date] NOT NULL,
	[VIAJE_FECHA_LLEGADA] [date] NOT NULL,
	[VIAJE_FECHA_LLEGADAE] [date] NOT NULL,
	[AERO_MATRI] [varchar] (8) NOT NULL,
	[RUTA_COD] [int] NOT NULL,
	[VIAJE_OK] [int] NULL,
 CONSTRAINT [PK_VIAJES] PRIMARY KEY CLUSTERED 
(
	[VIAJE_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [ABSTRACCIONX4].[VIAJES]  WITH CHECK ADD  CONSTRAINT [FK_VIAJES_AERONAVES] FOREIGN KEY([AERO_MATRI])
REFERENCES [ABSTRACCIONX4].[AERONAVES] ([AERO_MATRI])

GO

ALTER TABLE [ABSTRACCIONX4].[VIAJES]  WITH CHECK ADD  CONSTRAINT [FK_VIAJES_RUTAS_AEREAS] FOREIGN KEY([RUTA_COD])
REFERENCES [ABSTRACCIONX4].[RUTAS_AEREAS] ([RUTA_COD])

GO


-- Tabla Pasajes

CREATE TABLE [ABSTRACCIONX4].[PASAJES](
	[PASAJE_COD] [int] IDENTITY NOT NULL,
	[USERNAME] [varchar] (100) NOT NULL,
	[VIAJE_COD] [int] NOT NULL,
	[PASAJE_PRECIO] [int] NOT NULL,
	[PASAJE_FECHA_COMPRA] [date] NOT NULL,
	[PASAJE_BUT_NRO] [int] NOT NULL,
	[PASAJE_BUT_TIPO] [varchar] (100) NOT NULL,
	[PASAJE_BUT_PISO] [int] NOT NULL,
	[PASAJE_CANCELADO] [int] NULL,
 CONSTRAINT [PK_PASAJES] PRIMARY KEY CLUSTERED 
(
	[PASAJE_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

ALTER TABLE [ABSTRACCIONX4].[PASAJES]  WITH CHECK ADD  CONSTRAINT [FK_PASAJES_USUARIOS] FOREIGN KEY([USERNAME])
REFERENCES [ABSTRACCIONX4].[USUARIOS] ([USERNAME])

GO

ALTER TABLE [ABSTRACCIONX4].[PASAJES]  WITH CHECK ADD  CONSTRAINT [FK_PASAJES_VIAJES] FOREIGN KEY([VIAJE_COD])
REFERENCES [ABSTRACCIONX4].[VIAJES] ([VIAJE_COD])

GO

-- Tabla Encomiendas:

CREATE TABLE [ABSTRACCIONX4].[ENCOMIENDAS](
	[ENCOMIENDA_COD] [int] IDENTITY NOT NULL,
	[USERNAME] [varchar] (100) NOT NULL,
	[VIAJE_COD] [int] NOT NULL,
	[ENCOMIENDA_PRECIO] [int] NOT NULL,	
	[ENCOMIENDA_FECHA_COMPRA] [date] NOT NULL,
	[ENCOMIENDA_PESO_KG] [int] NOT NULL,
	[ENCOMIENDA_CANCELADO] [int] NULL,
 CONSTRAINT [PK_ENCOMIENDAS] PRIMARY KEY CLUSTERED 
(
	[ENCOMIENDA_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


ALTER TABLE [ABSTRACCIONX4].[ENCOMIENDAS]  WITH CHECK ADD  CONSTRAINT [FK_ENCOMIENDAS_USUARIOS] FOREIGN KEY([USERNAME])
REFERENCES [ABSTRACCIONX4].[USUARIOS] ([USERNAME])

GO

ALTER TABLE [ABSTRACCIONX4].[ENCOMIENDAS]  WITH CHECK ADD  CONSTRAINT [FK_ENCOMIENDAS_VIAJES] FOREIGN KEY([VIAJE_COD])
REFERENCES [ABSTRACCIONX4].[VIAJES] ([VIAJE_COD])

GO

-- Tabla Devoluciones

CREATE TABLE [ABSTRACCIONX4].[DEVOLUCIONES](
	[DEVOLUC_COD] [int] IDENTITY NOT NULL,
	[DEVOLUC_FECHA] [date] NOT NULL,
	[DEVOLUC_NRO_COMPRA] [int] NOT NULL,
	[ENCOMIENDA_COD] [int] NULL,	
	[PASAJE_COD] [int] NULL,
	[DEVOLUC_MOTIVO] [char] (255) NULL,
 CONSTRAINT [PK_DEVOLUCIONES] PRIMARY KEY CLUSTERED 
(
	[DEVOLUC_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


ALTER TABLE [ABSTRACCIONX4].[DEVOLUCIONES]  WITH CHECK ADD  CONSTRAINT [FK_DEVOLUCIONES_PASAJES] FOREIGN KEY([PASAJE_COD])
REFERENCES [ABSTRACCIONX4].[PASAJES] ([PASAJE_COD])

GO

ALTER TABLE [ABSTRACCIONX4].[DEVOLUCIONES]  WITH CHECK ADD  CONSTRAINT [FK_DEVOLUCIONES_ENCOMIENDAS] FOREIGN KEY([ENCOMIENDA_COD])
REFERENCES [ABSTRACCIONX4].[ENCOMIENDAS] ([ENCOMIENDA_COD])

GO


-- Tabla de Premios

CREATE TABLE [ABSTRACCIONX4].[PREMIOS](
	[PREMIO_COD] [int] IDENTITY NOT NULL,	
	[PREMIO_PUNTOS] [int] NOT NULL,
	[PREMIO_DETALLE] [char] (255) NOT NULL,
 CONSTRAINT [PK_PREMIOS] PRIMARY KEY CLUSTERED 
(
	[PREMIO_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO

-- Tabla de Canjes

CREATE TABLE [ABSTRACCIONX4].[CANJES](
	[CANJE_COD] [int] IDENTITY NOT NULL,
	[CANJE_NRO_DOC] [int] NOT NULL,
	[CANJE_FECHA] [date] NOT NULL,	
	[PREMIO_COD] [int] NOT NULL,
	[CANJE_CANTIDAD] [int] NOT NULL,
	[USERNAME] [varchar] (100) NOT NULL,
 CONSTRAINT [PK_CANJES] PRIMARY KEY CLUSTERED 
(
	[CANJE_COD] 
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO


ALTER TABLE [ABSTRACCIONX4].[CANJES]  WITH CHECK ADD  CONSTRAINT [FK_CANJES_PREMIOS] FOREIGN KEY([PREMIO_COD])
REFERENCES [ABSTRACCIONX4].[PREMIOS] ([PREMIO_COD])

GO

ALTER TABLE [ABSTRACCIONX4].[CANJES]  WITH CHECK ADD  CONSTRAINT [FK_CANJES_USUARIOS] FOREIGN KEY([USERNAME])
REFERENCES [ABSTRACCIONX4].[USUARIOS] ([USERNAME])

GO


-- =============================================================================================
-- Descripción:	Migración de Tabla Maestra
-- =============================================================================================

--Inserta las ciudades en la tabla de ciudades

INSERT INTO [ABSTRACCIONX4].[CIUDADES] (CIU_DESC)
SELECT DISTINCT RUTA_CIUDAD_ORIGEN FROM gd_esquema.Maestra
GO

--Inserta las aeronaves en la tabla de aeronaves
INSERT INTO [ABSTRACCIONX4].[AERONAVES] (AERO_MOD , AERO_MATRI , AERO_CANT_BUTACAS,  AERO_CANT_KGS , AERO_FAB , AERO_SERV)
SELECT Aeronave_Modelo , Aeronave_Matricula matricula, max(Butaca_Nro), Aeronave_KG_Disponibles , Aeronave_Fabricante , Tipo_Servicio 
FROM gd_esquema.Maestra
GROUP BY Aeronave_Modelo , Aeronave_Matricula , Aeronave_KG_Disponibles , Aeronave_Fabricante , Tipo_Servicio
GO

-- Inserta los roles en la tabla roles
INSERT [ABSTRACCIONX4].[ROLES] (ROL_NOMBRE)
VALUES ('CLIENTE')
INSERT [ABSTRACCIONX4].[ROLES] (ROL_NOMBRE)
VALUES ('ADMINISTRADOR')




